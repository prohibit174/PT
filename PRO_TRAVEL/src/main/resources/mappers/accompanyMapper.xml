<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="pro_travel.mapper.accompanyMapper">

	<select id="getUserRoute" resultType="AccompanyVO"
		parameterType="String">
		select tp_num, c.cor_region, cor_longi, cor_lati, u_id, tp_date
		from cordinates c, trip_plan t where c.cor_region = t.cor_region and
		t.u_id=#{u_id} order by tp_date
	</select>
	
	<select id="getUserInfo" resultType="AccompanyVO" parameterType="String">
		select tp_num, c.cor_region, cor_longi, cor_lati, u.u_id, tp_date,
		u_birth,u_sex,u_lang,u_religion,u_job
		from cordinates c, trip_plan t, users u where c.cor_region = t.cor_region
		and t.u_id= u.u_id and t.u_id=#{u_id}
	</select>
	<select id="getAccompanies" resultType="AccompanyVO"
		parameterType="AccompanyVO">
		select * from users u, trip_plan t, cordinates c
		where u.u_id!=#{u_id} and u.u_id = t.u_id and c.COR_REGION=t.COR_REGION
		and
		TO_CHAR(t.tp_date,'YYYY/MM/DD')=SUBSTR(#{tp_date},0,4)||'/'||SUBSTR(#{tp_date},6,2)||'/'||SUBSTR(#{tp_date},9,2)
		and c.cor_lati=(select cor_lati from cordinates c where
		cor_region=#{cor_region})
		and c.cor_longi=(select cor_longi from cordinates c where
		cor_region=#{cor_region})
		<!-- order by case when u.ts_id='0' then 1 when ABS(to_number(SUBSTR(u.u_birth,0,4))-to_number(SUBSTR(#{u_birth},0,4))) 
			&lt; 5 then 2 when u.u_sex=#{u_sex} then 3 when u.u_lang=#{u_lang} then 4 
			when u.u_religion=#{u_religion} then 5 when u.u_job=#{u_job} then 1 end -->
	</select>

	<insert id="insertRoute" parameterType="RouteVO">
		insert into Trip_Plan(
		tp_num,cor_region,u_id,tp_date
		)
		values(
		(select max(tp_num) from trip_plan)+1,#{cor_region},#{u_id},#{tp_date}
		<!-- '3','3','3','2017-04-15' -->
		)
	</insert>

	<select id="getTraveler" parameterType="RouteVO" resultType="AccompanyVO">
		select tp.*, u.* from trip_plan tp, users u where tp.u_id = u.u_id and tp.u_id != #{u_id} and tp.cor_region = #{cor_region} and tp.tp_date = #{tp_date}  order by  tp_date ASC
	</select>

	<select id="getCordinates" resultType="cordinatesVO">
      select * from cordinates
   	</select>

	
	<select id="initGroup" resultType="String">
		select max(accomp_group_num) from ACCOMP_GROUP
	</select>
	
	<insert id="registGroupZero" parameterType="GroupVO">
		insert into ACCOMP_GROUP values(1 ,#{u_id} ,#{max_people_num} ,#{COR_REGION} ,#{TP_DATE})
	</insert>	

	<insert id="registGroup" parameterType="GroupVO">
		insert into ACCOMP_GROUP values((select max(accomp_group_num) from ACCOMP_GROUP)+1 ,#{u_id} ,#{max_people_num} ,#{COR_REGION} ,#{TP_DATE})
	</insert>	


</mapper>
  